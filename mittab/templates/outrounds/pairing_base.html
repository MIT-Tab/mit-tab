{% extends "base/__wide.html" %}

{% load tags %}

{% block title %}Round Status{% endblock %}

{% block content %}
<div id="round-number"
     data-round-number="{{ num_teams }}"
     data-round-numbers="{% for rn in stats_round_numbers %}{{ rn }}{% if not forloop.last %},{% endif %}{% endfor %}"
     style="display: none;"></div>
    <div class="col">
  <div class="containter">
      <div class="row">
    <div class="col">
        <h3>
      Round Status for {{ label }}
      <small class="{% if not errors or num_excluded == 0 %}text-success{% else %}text-danger{% endif %}">
          {% if not errors or num_excluded == 0 %} Valid {% else %} Invalid {% endif %} pairing
      </small>
        </h3>
    </div>
    <div class="col d-flex justify-content-end align-items-start">
      <form method="get" class="form-inline">
        <label class="mr-2" for="select-varsity">Varsity</label>
        <select id="select-varsity" name="select_varsity" class="form-control form-control-sm mr-3" onchange="this.form.submit()">
          <option value="">None</option>
          {% for option in available_varsity_rounds %}
          <option value="{{ option.num_teams }}" {% if selected_varsity == option.num_teams %}selected{% endif %}>
            {{ option.label }}
          </option>
          {% endfor %}
        </select>

        <label class="mr-2" for="select-novice">Novice</label>
        <select id="select-novice" name="select_novice" class="form-control form-control-sm mr-3" onchange="this.form.submit()">
          <option value="">None</option>
          {% for option in available_novice_rounds %}
          <option value="{{ option.num_teams }}" {% if selected_novice == option.num_teams %}selected{% endif %}>
            {{ option.label }}
          </option>
          {% endfor %}
        </select>
      </form>
    </div>
      </div> <!-- end heading row -->
      <hr /> 
      <div class="row mb-3">
    <div class="col-8">
      <h6>Pairing Controls</h6>
      <div class="btn-group btn-group-sm">
        <form action="{% url 'outround_assign_judges' %}"
            method="post"
            onsubmit="return confirm('Do you really want to assign judges. All previous assignments will be lost.  If you are unsure, click cancel and back up')"
            class="d-inline"
          >
            {% csrf_token %}
            {% return_to_input return_path %}
            <input type="hidden" name="selected_varsity" value="{{ selected_varsity|default_if_none:'' }}">
            <input type="hidden" name="selected_novice" value="{{ selected_novice|default_if_none:'' }}">
            <button id="assign-judges" type="submit" class="mid btn btn-sm btn-warning" title="Assign judges to your pairing">
              <i class="fas fa-gavel"></i> Assign Judges
            </button>
          </form>
          <form action="{% url 'outround_assign_rooms' %}"
            method="post"
            onsubmit="return confirm('Do you really want to assign rooms? All previous assignments will be lost. If you are unsure, click cancel and back up')"
            class="d-inline"
          >
            {% csrf_token %}
            {% return_to_input return_path %}
            <input type="hidden" name="selected_varsity" value="{{ selected_varsity|default_if_none:'' }}">
            <input type="hidden" name="selected_novice" value="{{ selected_novice|default_if_none:'' }}">
            <button id="assign-rooms" type="submit" class="mid btn btn-sm btn-warning" title="Assign rooms to your pairing">
              <i class="fas fa-chalkboard-teacher"></i> Assign Rooms
            </button>
          </form>
      </div>
    </div>
      </div> <!-- end control row -->
      {% if warnings %}
      <div class="alert alert-danger warning-container">
        <strong class="warning-text">Warning: Hover to see details.</strong>
        <div class="alert alert-danger warning-popup">
          <ul>
            {% for warning in warnings %}
              <li>{{ warning }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      <div class="row">
    {% if not outround_sections %}
      <div class="col-12">
        <div class="alert alert-warning">No selected rounds to display.</div>
      </div>
    {% endif %}
    {% for section in outround_sections %}
        <div class="col-12 mt-2 mb-2 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{ section.label }}</h5>
          <div class="btn-group btn-group-sm">
            <a class="btn btn-success outround-release close-pairings-btn {% if not section.pairing_released %}d-none{% endif %}"
               href="#"
               data-release-key="{{ section.type_of_round }}-{{ section.num_teams }}"
               data-num_teams="{{ section.num_teams }}"
               data-type_of_round="{{ section.type_of_round }}"
               title="Close pairings for this round">
              <i class="fas fa-door-closed"></i> Close Pairings
            </a>
            <a class="btn btn-warning outround-release open-pairings-btn {% if section.pairing_released %}d-none{% endif %}"
               href="#"
               data-release-key="{{ section.type_of_round }}-{{ section.num_teams }}"
               data-num_teams="{{ section.num_teams }}"
               data-type_of_round="{{ section.type_of_round }}"
               title="Release pairings for this round">
              <i class="fas fa-door-open"></i> Release Pairings
            </a>
            {% if section.num_teams > 2 %}
            <a class="btn btn-info"
               href="/outround_pairing/pair/{{ section.type_of_round }}/{{ section.num_teams }}"
               title="Pair the next round of debate for this bracket">
              <i class="fas fa-arrow-right"></i> Prepare Next Round
            </a>
            {% endif %}
            <a class="btn btn-secondary" href="{% url 'outround_pretty_pair' section.type_of_round %}" title="To display in GA">
              <i class="fas fa-tv"></i> Announcement View
            </a>
            <a class="btn btn-secondary" href="/outround_pairings/export_csv/{{ section.type_of_round }}/" title="Export pairings as CSV">
              <i class="fas fa-download"></i> Export CSV
            </a>
            <a class="btn btn-secondary" href="/outround_result/{{ section.type_of_round }}">
              Forum View
            </a>
          </div>
        </div>
    {% for pairing in section.outrounds %}
        <div class="col-xl-6">
      {% with judge_slots=section.judge_slots %}
      {% include "outrounds/pairing_card.html" %}
      {% endwith %}
        </div>
    {% endfor %}
    {% endfor %}
      </div> <!-- end pairings row -->
      <div class="row mt-2 mb-2">
    <div class="col not-paired-in overflow-auto border-bottom">
        <h5>People Not Paired In</h5>
        <table class="table table-striped table-sm">
      <thead>
          <th>Unpaired in Teams ({{ excluded_teams|length }})</th>
          <th>Checked in Judges ({{ excluded_judges|length }})</th>
          <th>Non Checked in Judges ({{ non_checkins|length }})</th>
          <th>Available Rooms ({{ available_rooms|length }})</th>
      </thead>
      {% for team, cjudge, judge, room in excluded_people %}
          <tr>
        <td>
            {% if team %} <a href="/team/{{team.id}}" >{{team.name}}</a> {% endif %}
        </td>
        <td>
            {% if cjudge %} <a href="/judge/{{cjudge.id}}" >{{cjudge.name}}</a> {% endif %}
        </td>
        <td>
            {% if judge %} <a class="{% if judge.rank > warning %}text-danger{%endif%}"href="/judge/{{judge.id}}" >{{judge.name}}</a> {% endif %}
        </td>
        <td>
            {% if room %} <a href="/room/{{room.id}}" >{{room.name}}</a> {% endif %}
        </td>
          </tr>
      {% endfor %}
        </table>
    </div>
      </div><!-- end not-paired-in row -->
  </div>
    </div>
{% endblock %}
