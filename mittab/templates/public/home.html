{% extends "base/__wide.html" %}
{% load tags %}
{% load render_bundle from webpack_loader %}

{% block title %}{% tournament_name %}{% endblock %}

{% block extra_head %}
  {% render_bundle 'publicDisplay' %}
{% endblock %}

{% block banner %}{% endblock %}

{% block content %}
<div class="col-12 d-flex justify-content-center public-home-wrapper">
  <div class="public-home">
    <div class="grid">
      <aside class="sidebar">
        <div class="public-sidebar-card status">
          <h3 class="title">Welcome to {% tournament_name %}!</h3>
          <div class="content">
            <div class="status-block" data-status>
              <!-- Status will be dynamically updated by JavaScript -->
              <div class="status-icon" aria-hidden="true" data-status-icon>
                <i class="fas fa-clipboard-check"></i>
              </div>
              <div class="status-text" aria-live="polite">
                <div class="status-primary" data-status-primary>Loading...</div>
                <div class="status-secondary" data-status-secondary></div>
              </div>
            </div>
            
            <div class="divider"></div>
            
            <div class="item">
              <div class="text">
                <strong>Tournament Updates</strong>
                <p>Check back regularly for updated pairings, results, and standings throughout the tournament.</p>
              </div>
            </div>
            
            <div class="item">
              <div class="text">
                <strong>For Judges</strong>
                <p>Use your ballot code to submit results electronically via the E-Ballot link.</p>
              </div>
            </div>
            
            <div class="item">
              <div class="text">
                <strong>For Teams</strong>
                <p>View your matchups in Released Pairings and track your progress in Team Rankings.</p>
              </div>
            </div>
            
            <div class="item">
              <div class="text">
                <strong>Staff Login</strong>
                <p><a href="{% url 'tab_login' %}">Login here</a> if you're tournament staff to access admin features.</p>
              </div>
            </div>
          </div>
        </div>
      </aside>
      
      <aside class="links" aria-labelledby="public-home-quick-links">
        <header class="header mobile-only">
          <h1 class="title" id="public-home-quick-links">Welcome to {% tournament_name %}!</h1>
          <h2 class="status-title mb-2">Status:</h2>
          <div class="status-block status-block--inline" data-status>
            <div class="status-icon" aria-hidden="true" data-status-icon>
              <i class="fas fa-clipboard-check"></i>
            </div>
            <span class="status-divider" aria-hidden="true"></span>
            <div class="status-text" aria-live="polite">
              <div class="status-primary" data-status-primary>Loading...</div>
              <div class="status-secondary" data-status-secondary></div>
            </div>
          </div>
        </header>

        <nav class="public-links" aria-label="Quick links">
          <a class="tile shadow-sm" href="{% url 'pretty_pair' %}">
            <span class="body">
              <span class="title">Released Pairings</span>
              <span class="subtitle">Latest rounds and room assignments.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="tile shadow-sm" href="{% url 'missing_ballots' %}">
            <span class="body">
              <span class="title">Missing Ballots</span>
              <span class="subtitle">Outstanding ballots that need attention.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
                    <a class="tile shadow-sm" href="{% url 'e_ballot_search' %}">
            <span class="body">
              <span class="title">Submit E-Ballot</span>
              <span class="subtitle">Judges enter ballot codes to file results.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="tile shadow-sm" href="{% url 'public_judges' %}">
            <span class="body">
              <span class="title">Judge List</span>
              <span class="subtitle">Roster and check-in status.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="tile shadow-sm" href="{% url 'public_teams' %}">
            <span class="body">
              <span class="title">Team List</span>
              <span class="subtitle">Registered teams and schools.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="tile shadow-sm" href="{% url 'outround_pretty_pair' 0 %}">
            <span class="body">
              <span class="title">Varsity Outrounds</span>
              <span class="subtitle">Varsity elimination brackets and pairings.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="tile shadow-sm" href="{% url 'outround_pretty_pair' 1 %}">
            <span class="body">
              <span class="title">Novice Outrounds</span>
              <span class="subtitle">Novice elimination brackets and pairings.</span>
            </span>
            <span class="chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
        </nav>
      </aside>
    </div>
  </div>
</div>

<script>
(function() {
  const curRound = {{ cur_round }};
  const totRounds = {{ tot_rounds }};
  const pairingReleased = {{ pairing_released|yesno:"true,false" }};
  const missingBallots = {{ missing_ballots_count }};
  const inOutrounds = {{ in_outrounds|yesno:"true,false" }};
  const currentOutroundLabel = "{{ current_outround_label|escapejs }}";

  const statusBlocks = Array.from(document.querySelectorAll('[data-status]'))
    .map((block) => ({
      shell: block.querySelector('[data-status-icon]'),
      primary: block.querySelector('[data-status-primary]'),
      secondary: block.querySelector('[data-status-secondary]'),
    }))
    .filter(({ shell, primary, secondary }) => shell && primary && secondary);

  if (!statusBlocks.length) {
    return;
  }

  function setStatusState() {
    statusBlocks.forEach(({ shell }) => {
      shell.className = 'status-icon';
    });
  }

  function updateStatus() {
    function applyTexts(primaryText, secondaryText) {
      statusBlocks.forEach(({ primary, secondary }) => {
        primary.textContent = primaryText;
        secondary.textContent = secondaryText;
      });
    }

    // During outrounds
    if (inOutrounds && currentOutroundLabel) {
      if (pairingReleased) {
        setStatusState();
        applyTexts(
          currentOutroundLabel,
          missingBallots > 0
            ? `${missingBallots} ballot${missingBallots !== 1 ? 's' : ''} missing`
            : 'All ballots in'
        );
      } else {
        setStatusState();
        applyTexts(currentOutroundLabel, 'Pairing in progress');
      }
      return;
    }
    
    // During inrounds
    if (curRound > 1 && curRound <= totRounds + 1) {
      const displayRound = curRound - 1;
      if (pairingReleased) {
        setStatusState();
        applyTexts(
          `Round ${displayRound}`,
          missingBallots > 0
            ? `${missingBallots} ballot${missingBallots !== 1 ? 's' : ''} missing`
            : 'All ballots in'
        );
      } else {
        setStatusState();
        applyTexts(`Round ${displayRound}`, 'Pairing in progress');
      }
      return;
    }
    
    // Default state
    setStatusState();
    applyTexts('Tournament', 'Check back for updates');
  }

  // Update immediately
  updateStatus();
  
  // Update every second for countdown
  setInterval(updateStatus, 1000);
})();
</script>
{% endblock %}
