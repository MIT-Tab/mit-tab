{% extends "base/__wide.html" %}
{% load tags %}

{% block title %}{% tournament_name %} â€¢ Public Hub{% endblock %}

{% block banner %}{% endblock %}

{% block content %}
<div class="col-12 d-flex justify-content-center public-home-wrapper">
  <div class="public-home">
    <div class="public-home__grid">
      <aside class="public-home__sidebar">
        <div class="public-sidebar-card public-sidebar-card--status">
          <h3 class="public-sidebar-card__title">{% tournament_name %}</h3>
          <div class="public-sidebar-card__content">
            <div id="tournament-status">
              <!-- Status will be dynamically updated by JavaScript -->
              <div class="status-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="status-text">
                <div class="status-primary" id="status-primary">Loading...</div>
                <div class="status-secondary" id="status-secondary"></div>
              </div>
            </div>
            
            <div class="public-sidebar-card__divider"></div>
            
            <div class="public-sidebar-card__item">
              <div class="public-sidebar-card__icon">
                <i class="fas fa-info-circle"></i>
              </div>
              <div class="public-sidebar-card__text">
                <strong>Tournament Updates</strong>
                <p>Check back regularly for updated pairings, results, and standings throughout the tournament.</p>
              </div>
            </div>
            
            <div class="public-sidebar-card__item">
              <div class="public-sidebar-card__icon public-sidebar-card__icon--warning">
                <i class="fas fa-gavel"></i>
              </div>
              <div class="public-sidebar-card__text">
                <strong>For Judges</strong>
                <p>Use your ballot code to submit results electronically via the E-Ballot link.</p>
              </div>
            </div>
            
            <div class="public-sidebar-card__item">
              <div class="public-sidebar-card__icon public-sidebar-card__icon--success">
                <i class="fas fa-users"></i>
              </div>
              <div class="public-sidebar-card__text">
                <strong>For Teams</strong>
                <p>View your matchups in Released Pairings and track your progress in Team Rankings.</p>
              </div>
            </div>
            
            <div class="public-sidebar-card__item">
              <div class="public-sidebar-card__icon public-sidebar-card__icon--info">
                <i class="fas fa-sign-in-alt"></i>
              </div>
              <div class="public-sidebar-card__text">
                <strong>Staff Login</strong>
                <p><a href="{% url 'tab_login' %}">Login here</a> if you're tournament staff to access admin features.</p>
              </div>
            </div>
          </div>
        </div>
      </aside>
      
      <aside class="public-home__links" aria-labelledby="public-home-quick-links">
        <header class="public-home__header public-home__header--mobile-only">
          <span class="public-home__label public-home__label--accent">Tournament</span>
          <h1 class="public-home__title" id="public-home-quick-links">{% tournament_name %}</h1>
        </header>
        <p class="public-home__lede">
          Live updates for pairings, ballots, and standings. Tab staff post here the moment information is released.
        </p>

        <nav class="public-links" aria-label="Quick links">
          <a class="public-links__tile public-links__tile--primary" href="{% url 'pretty_pair' %}">
            <span class="public-links__icon"><i class="fas fa-th-large"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Released Pairings</span>
              <span class="public-links__subtitle">Latest rounds and room assignments.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="public-links__tile public-links__tile--warning" href="{% url 'missing_ballots' %}">
            <span class="public-links__icon"><i class="fas fa-clipboard-check"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Missing Ballots</span>
              <span class="public-links__subtitle">Outstanding ballots that need attention.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="public-links__tile public-links__tile--success" href="{% url 'rank_teams_public' %}">
            <span class="public-links__icon"><i class="fas fa-trophy"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Team Rankings</span>
              <span class="public-links__subtitle">Current standings and performance.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="public-links__tile public-links__tile--info" href="{% url 'e_ballot_search' %}">
            <span class="public-links__icon"><i class="fas fa-tablet-alt"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Submit E-Ballot</span>
              <span class="public-links__subtitle">Judges enter ballot codes to file results.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="public-links__tile public-links__tile--success" href="{% url 'public_judges' %}">
            <span class="public-links__icon"><i class="fas fa-balance-scale"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Judge List</span>
              <span class="public-links__subtitle">Roster and check-in status.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
          <a class="public-links__tile public-links__tile--neutral" href="{% url 'public_teams' %}">
            <span class="public-links__icon"><i class="fas fa-users"></i></span>
            <span class="public-links__body">
              <span class="public-links__title">Team List</span>
              <span class="public-links__subtitle">Registered teams and schools.</span>
            </span>
            <span class="public-links__chevron"><i class="fas fa-arrow-right"></i></span>
          </a>
        </nav>
      </aside>
    </div>
  </div>
</div>

<script>
(function() {
  const curRound = {{ cur_round }};
  const totRounds = {{ tot_rounds }};
  const pairingReleased = {{ pairing_released|yesno:"true,false" }};
  const missingBallots = {{ missing_ballots_count }};
  const tournamentStartTime = "{{ tournament_start_time|escapejs }}";
  const inOutrounds = {{ in_outrounds|yesno:"true,false" }};
  const currentOutroundLabel = "{{ current_outround_label|escapejs }}";

  const statusIcon = document.querySelector('.status-icon i');
  const statusPrimary = document.getElementById('status-primary');
  const statusSecondary = document.getElementById('status-secondary');

  function updateStatus() {
    // Before round 1 (cur_round == 1)
    if (curRound === 1 && tournamentStartTime) {
      const startTime = new Date(tournamentStartTime);
      const now = new Date();
      
      if (now < startTime) {
        // Show countdown
        const diff = startTime - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        statusIcon.className = 'fas fa-clock';
        statusIcon.parentElement.className = 'status-icon status-icon--info';
        statusPrimary.textContent = 'Tournament Starts In';
        
        if (days > 0) {
          statusSecondary.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        } else if (hours > 0) {
          statusSecondary.textContent = `${hours}h ${minutes}m ${seconds}s`;
        } else if (minutes > 0) {
          statusSecondary.textContent = `${minutes}m ${seconds}s`;
        } else {
          statusSecondary.textContent = `${seconds}s`;
        }
        return;
      }
    }
    
    // During outrounds
    if (inOutrounds && currentOutroundLabel) {
      if (pairingReleased) {
        statusIcon.className = 'fas fa-clipboard-check';
        statusIcon.parentElement.className = 'status-icon status-icon--warning';
        statusPrimary.textContent = currentOutroundLabel;
        if (missingBallots > 0) {
          statusSecondary.textContent = `${missingBallots} ballot${missingBallots !== 1 ? 's' : ''} missing`;
        } else {
          statusSecondary.textContent = 'All ballots in';
        }
      } else {
        statusIcon.className = 'fas fa-cog fa-spin';
        statusIcon.parentElement.className = 'status-icon status-icon--primary';
        statusPrimary.textContent = currentOutroundLabel;
        statusSecondary.textContent = 'Pairing in progress';
      }
      return;
    }
    
    // During inrounds
    if (curRound > 1 && curRound <= totRounds + 1) {
      const displayRound = curRound - 1;
      if (pairingReleased) {
        statusIcon.className = 'fas fa-clipboard-check';
        statusIcon.parentElement.className = 'status-icon status-icon--warning';
        statusPrimary.textContent = `Round ${displayRound}`;
        if (missingBallots > 0) {
          statusSecondary.textContent = `${missingBallots} ballot${missingBallots !== 1 ? 's' : ''} missing`;
        } else {
          statusSecondary.textContent = 'All ballots in';
        }
      } else {
        statusIcon.className = 'fas fa-cog fa-spin';
        statusIcon.parentElement.className = 'status-icon status-icon--primary';
        statusPrimary.textContent = `Round ${displayRound}`;
        statusSecondary.textContent = 'Pairing in progress';
      }
      return;
    }
    
    // Default state
    statusIcon.className = 'fas fa-info-circle';
    statusIcon.parentElement.className = 'status-icon status-icon--info';
    statusPrimary.textContent = 'Tournament';
    statusSecondary.textContent = 'Check back for updates';
  }

  // Update immediately
  updateStatus();
  
  // Update every second for countdown
  setInterval(updateStatus, 1000);
})();
</script>
{% endblock %}
