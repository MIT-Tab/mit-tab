{% extends "base/__wide.html" %}

{% block title %}Registration Admin{% endblock %}
{% block banner %}Registration Admin{% endblock %}

{% block content %}
<div class="col-12">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <div class="mb-2">
            <h5 class="mb-1">Registration Settings &amp; Submissions</h5>
            <p class="text-muted mb-0">Toggle availability and manage existing registrations.</p>
        </div>
        <a class="btn btn-primary mb-2" href="{% url 'registration_portal' %}">Open Portal</a>
    </div>

    <form method="post" class="mb-3">
        {% csrf_token %}
        <div class="d-flex flex-wrap align-items-center bg-light border rounded p-3">
            <div class="custom-control custom-switch mr-4 mb-2">
                {{ form.allow_new_registrations }}
                <label class="custom-control-label" for="{{ form.allow_new_registrations.id_for_label }}">
                    Allow New Registrations
                </label>
            </div>
            <div class="custom-control custom-switch mr-4 mb-2">
                {{ form.allow_registration_edits }}
                <label class="custom-control-label" for="{{ form.allow_registration_edits.id_for_label }}">
                    Allow Registration Updates
                </label>
            </div>
            <button type="submit" class="btn btn-sm btn-primary ml-auto">Save</button>
        </div>
        {% if form.errors %}
        <div class="alert alert-danger mt-2 mb-0">
            Please fix the errors above and try again.
        </div>
        {% endif %}
    </form>

    {% if registrations %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead class="thead-light">
                <tr>
                    <th scope="col">School / Contact</th>
                    <th scope="col">Teams</th>
                    <th scope="col">Judges</th>
                    <th scope="col">Code</th>
                    <th scope="col">Timestamps</th>
                    <th scope="col" class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for registration in registrations %}
                <tr>
                    <td>
                        <div class="font-weight-bold">{{ registration.school.name }}</div>
                        <div class="text-muted small">{{ registration.email }}</div>
                    </td>
                    <td>
                        <span class="badge badge-light">{{ registration.team_count }} teams</span>
                        {% if registration.team_count %}
                        <ul class="mb-0 small pl-3">
                            {% for team in registration.teams.all %}
                            <li>
                                <strong>{{ team.name }}</strong>
                                {% if team.debaters.all %}
                                <span class="text-muted">
                                    —
                                    {% for debater in team.debaters.all %}
                                        {{ debater.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-light">{{ registration.judge_count }} judges</span>
                        {% if registration.judge_count %}
                        <ul class="mb-0 small pl-3">
                            {% for judge in registration.judges.all %}
                            <li>
                                <strong>{{ judge.name }}</strong>
                                {% if judge.schools.all %}
                                <span class="text-muted">
                                    —
                                    {% for school in judge.schools.all %}
                                        {{ school.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </td>
                    <td><code>{{ registration.herokunator_code }}</code></td>
                    <td>
                        <div>{{ registration.created_at|date:"M j, Y, H:i" }}</div>
                        <div class="text-muted small">Updated {{ registration.updated_at|date:"M j, Y, H:i" }}</div>
                    </td>
                    <td class="text-right">
                        <a class="btn btn-sm btn-outline-primary mr-1" href="{% url 'registration_portal_edit' registration.herokunator_code %}">Open</a>
                        <form method="post" class="d-inline" onsubmit="return confirm('Delete this registration and all related teams/judges?');">
                            {% csrf_token %}
                            <input type="hidden" name="registration_id" value="{{ registration.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">No registrations have been submitted yet.</div>
    {% endif %}
</div>
{% endblock %}
