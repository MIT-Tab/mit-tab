#!/bin/bash
set -e
set +x

if [[ "${MYSQL_HOST:-127.0.0.1}" != "127.0.0.1" && "${MYSQL_HOST:-127.0.0.1}" != "localhost" ]]; then
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  # shellcheck disable=SC1090
  source "${SCRIPT_DIR}/lib/mysql_ssl.sh"
  ensure_mysql_ssl_cert
fi

printenv
if [ -x "$(command -v mysqladmin)" ]; then
  mysqladmin ping -h $MITTAB_DB_HOST -u root --password=$MYSQL_ROOT_PASSWORD --wait=30
fi
python manage.py migrate --noinput
npm install
./node_modules/.bin/webpack --config webpack.config.js --mode production
python manage.py collectstatic --noinput
python manage.py initialize_tourney --tab-password $1
